#!/usr/bin/env modbuild

module use Libraries

INSTANTCLIENT_INCLUDE_DIR='/usr/include/oracle/12.1/client64'
INSTANTCLIENT_LIBRARY_DIR='/usr/lib/oracle/12.1/client64/lib'

case ${OS} in
Darwin )
	# cocoa doesn't work with GCC!?
	#config_args='--enable-cocoa --disable-x11'
	config_args='--with-finkdir=/opt/X11 --disable-cocoa'
	;;
*)
	;;
esac

# enabled by default
# 	fftw3
#	oracle
#	xml
#
pbuild::configure() {
	"${MODULE_SRCDIR}"/configure \
		--disable-asimage \
		--disable-ldap \
		--disable-mysql \
		--disable-opengl \
		--disable-python \
		--enable-mathmore \
		--with-cc=${CC} \
		--with-cxx=${CXX} \
		--with-f77=${F77} \
		--with-ld=${CXX} \
		--with-oracle-incdir=${INSTANTCLIENT_INCLUDE_DIR} \
		--with-oracle-libdir=${INSTANTCLIENT_LIBRARY_DIR} \
		${config_args} \
		|| exit 1
}

pbuild::build() {
	make -j 4
}

pbuild::install() {
	make clean

	rm -f  Makefile
	rm -rf config.*
	rm -rf core
	rm -rf io
	rm -rf math
	rm -rf net
	rm -rf hist
	rm -rf tree
	rm -rf graf2d
	rm -rf graf3d
	rm -rf gui
	rm -rf html
	rm -rf montecarlo
	rm -rf geom
	rm -rf proof
	rm -rf sql
	rm -rf misc
	rm -rf test
	rm -rf tmva
	rm -rf tutorials
	rm -rf rootx

	mkdir -p share
	mv man share

	mkdir -p "${PREFIX}"
	cp -rv * "${PREFIX}"
	mkdir -p "${DOCDIR}"
	mv -f "${PREFIX}/LICENSE" "${DOCDIR}"
	rm -f "${DOCDIR}/README"
	mv -f "${PREFIX}/README"  "${DOCDIR}"
}

pbuild::postinstall() {
	cp -av "${INSTANTCLIENT_LIBRARY_DIR}/"libocci.so* "${PREFIX}"/lib
}

module use unstable
pbuild::add_to_group 'Compiler'
pbuild::set_runtime_dependencies "${COMPILER}"
pbuild::set_build_dependencies "${COMPILER}"
pbuild::make_all
